<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Recon - Web-ScannerAdmin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4f46e5;
            --secondary-color: #7c3aed;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --dark-color: #1f2937;
            --light-color: #f9fafb;
            --border-color: #e5e7eb;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--dark-color);
        }

        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 280px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-right: 1px solid var(--border-color);
            z-index: 1000;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            padding: 2rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }

        .sidebar-header h3 {
            font-weight: 700;
            font-size: 1.5rem;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .sidebar-header .subtitle {
            font-size: 0.875rem;
            opacity: 0.9;
            margin-top: 0.25rem;
        }

        .sidebar-menu { padding: 1.5rem 0; }
        .nav-item { margin: 0.25rem 0; }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 0.875rem 1.5rem;
            color: var(--dark-color);
            text-decoration: none;
            transition: all 0.3s ease;
            border: none;
            background: transparent;
            width: 100%;
            text-align: left;
            font-weight: 500;
        }

        .nav-link:hover {
            background: rgba(79, 70, 229, 0.1);
            color: var(--primary-color);
            transform: translateX(5px);
        }

        .nav-link.active {
            background: var(--primary-color);
            color: white;
        }

        .nav-link i { width: 20px; margin-right: 0.75rem; }

        .main-content {
            margin-left: 280px;
            padding: 2rem;
            min-height: 100vh;
        }

        .content-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .content-header h1 {
            font-weight: 700;
            font-size: 2.5rem;
            margin: 0;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .content-header p {
            color: #6b7280;
            margin: 0.5rem 0 0 0;
            font-size: 1.125rem;
        }

        .form-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
        }

        .form-label { font-weight: 500; margin-bottom: 0.5rem; color: var(--dark-color); }

        .form-control, .form-select {
            border: 2px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 0.75rem;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.8);
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(79, 70, 229, 0.25);
            background: white;
        }

        .btn {
            border-radius: 0.5rem;
            font-weight: 500;
            padding: 0.75rem 1.5rem;
            transition: all 0.3s ease;
            border: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(79, 70, 229, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color), #dc2626);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(239, 68, 68, 0.3);
        }

        .btn-outline-secondary {
            border: 2px solid var(--border-color);
            color: var(--dark-color);
            background: transparent;
        }

        .btn-outline-secondary:hover {
            background: var(--border-color);
            transform: translateY(-2px);
        }

        .scan-status {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 1rem;
            padding: 2rem;
            margin-top: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
        }

        .scan-status.active { display: block; }

        .progress {
            height: 10px;
            border-radius: 1rem;
            background: var(--border-color);
            overflow: hidden;
        }

        .progress-bar {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            transition: width 0.3s ease;
        }

        .verbose-container {
            background: #1a1a1a;
            border-radius: 0.5rem;
            padding: 1rem;
            max-height: 260px;
            overflow-y: auto;
        }

        .verbose-output {
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            color: #00ff00;
            line-height: 1.4;
        }

        .verbose-line { margin-bottom: 0.25rem; word-break: break-word; }
        .verbose-line.error { color: #ff6b6b; }
        .verbose-line.warning { color: #ffd93d; }

        .mobile-toggle {
            display: none;
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 1001;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 0.5rem;
            padding: 0.75rem;
            font-size: 1.25rem;
        }

        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.active { transform: translateX(0); }
            .main-content {
                margin-left: 0;
                padding: 1rem;
                padding-top: 4rem;
            }
            .mobile-toggle { display: block; }
            .content-header h1 { font-size: 2rem; }
        }

        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .tooltip-icon { color: var(--primary-color); cursor: help; margin-left: 0.25rem; }

        .result-pill {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.7rem;
            border-radius: 999px;
            background: rgba(79, 70, 229, 0.1);
            color: var(--primary-color);
            font-weight: 600;
        }

        .result-pill strong { color: var(--dark-color); }
    </style>
</head>
<body>
    <button class="mobile-toggle" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </button>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3><i class="fas fa-search"></i> Web-Scanner</h3>
            <div class="subtitle">Admin Dashboard</div>
        </div>
        <div class="sidebar-menu">
            <div class="nav-item">
                <a href="/" class="nav-link">
                    <i class="fas fa-tachometer-alt"></i>
                    Dashboard
                </a>
            </div>
            <div class="nav-item">
                <a href="/scan" class="nav-link">
                    <i class="fas fa-crosshairs"></i>
                    New Scan
                </a>
            </div>
            <div class="nav-item">
                <a href="/history" class="nav-link">
                    <i class="fas fa-history"></i>
                    Scan History
                </a>
            </div>
            <div class="nav-item">
                <a href="/recon" class="nav-link active">
                    <i class="fas fa-sitemap"></i>
                    New Recon
                </a>
            </div>
            <div class="nav-item">
                <a href="/recon/history" class="nav-link">
                    <i class="fas fa-folder-open"></i>
                    Recon History
                </a>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="content-header fade-in">
            <h1>New Recon</h1>
            <p>Python-only recon: subdomains (CT), DNS records, and live endpoint probing</p>
        </div>

        <div class="form-container fade-in">
            <form id="reconForm">
                <div class="row g-3">
                    <div class="col-md-12">
                        <label for="domain" class="form-label">
                            Target Domain
                            <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Enter a domain like example.com (no protocol needed)"></i>
                        </label>
                        <div class="input-group">
                            <span class="input-group-text" style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; border: none;">
                                <i class="fas fa-globe"></i>
                            </span>
                            <input type="text" class="form-control" id="domain" name="domain" placeholder="example.com" required>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <label for="engine" class="form-label">
                            Engine
                            <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="reconFTW runs all modules inside Docker (full OSINT, subdomains, hosts, web analysis, vulnerability checks)."></i>
                        </label>
                        <select class="form-select" id="engine" name="engine">
                            <option value="reconftw" selected>reconFTW Engine (Full)</option>
                        </select>
                    </div>

                    <div class="col-md-4">
                        <label for="threads" class="form-label">
                            Threads
                            <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Concurrency for probing hosts"></i>
                        </label>
                        <input type="number" class="form-control" id="threads" name="threads" value="20" min="1" max="200">
                    </div>

                    <div class="col-md-4">
                        <label for="max_hosts" class="form-label">
                            Max Hosts
                            <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Probe only the first N discovered subdomains to keep scans fast"></i>
                        </label>
                        <input type="number" class="form-control" id="max_hosts" name="max_hosts" value="200" min="1" max="5000">
                    </div>

                    <div class="col-md-4" id="pythonModeWrap">
                        <label for="mode" class="form-label">
                            Mode
                            <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Python engine supports passive discovery via certificate transparency + probing"></i>
                        </label>
                        <select class="form-select" id="mode" name="mode">
                            <option value="passive" selected>Passive (CT + DNS + Probe)</option>
                        </select>
                    </div>

                    <div class="col-md-8" id="reconftwFlagsWrap" style="display:none;">
                        <label for="reconftw_flags" class="form-label">
                            reconFTW Flags
                            <i class="fas fa-info-circle tooltip-icon" data-bs-toggle="tooltip" title="Default is -r (full). Example: -r --deep"></i>
                        </label>
                        <input type="text" class="form-control" id="reconftw_flags" name="reconftw_flags" value="-r" placeholder="-r">
                    </div>

                    <div class="col-md-4" id="reconftwInstallWrap" style="display:none;">
                        <label class="form-label">Auto Install Tools</label>
                        <div class="form-check mt-2">
                            <input class="form-check-input" type="checkbox" id="auto_install" name="auto_install" checked>
                            <label class="form-check-label" for="auto_install">
                                Run <code>install.sh</code> automatically if tools are missing
                            </label>
                        </div>
                    </div>
                </div>

                <div class="d-flex gap-2 mt-3">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-play"></i> Start Recon
                    </button>
                    <a href="/recon/history" class="btn btn-outline-secondary">
                        <i class="fas fa-folder-open"></i> Recon History
                    </a>
                </div>
            </form>
        </div>

        <div class="scan-status" id="reconStatus">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-chart-line"></i> Recon Progress</h5>
                <div class="d-flex gap-2">
                    <button class="btn btn-danger btn-sm" onclick="stopRecon()" id="stopBtn">
                        <i class="fas fa-stop"></i> Stop
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="viewReconResults()" id="viewBtn" disabled>
                        <i class="fas fa-eye"></i> View Results
                    </button>
                </div>
            </div>

            <hr>

            <div class="mb-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>Overall Progress</span>
                    <span id="progressText">0%</span>
                </div>
                <div class="progress">
                    <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                </div>
            </div>

            <div class="d-flex gap-3 flex-wrap mb-3">
                <div class="result-pill"><strong>Subdomains:</strong> <span id="summarySubs">0</span></div>
                <div class="result-pill"><strong>Live Endpoints:</strong> <span id="summaryLive">0</span></div>
                <div class="result-pill"><strong>Status:</strong> <span id="statusText">-</span></div>
            </div>

            <div class="mb-2 d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="fas fa-terminal"></i> Logs</h6>
                <small class="text-muted" id="timeText">-</small>
            </div>
            <div class="verbose-container">
                <div id="verboseOutput" class="verbose-output">
                    <div class="verbose-line">Waiting to start...</div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentReconId = null;
        let statusInterval = null;

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
        }

        function appendLogLine(entry) {
            const container = document.getElementById('verboseOutput');
            const line = document.createElement('div');
            line.className = 'verbose-line';
            if (entry.level && entry.level.toLowerCase() === 'error') line.classList.add('error');
            if (entry.level && entry.level.toLowerCase() === 'warning') line.classList.add('warning');
            const ts = entry.timestamp ? new Date(entry.timestamp).toLocaleTimeString() : '';
            line.textContent = `[${ts}] ${entry.level || 'INFO'}: ${entry.message || ''}`;
            container.appendChild(line);
            container.parentElement.scrollTop = container.parentElement.scrollHeight;
        }

        function resetLogs() {
            const container = document.getElementById('verboseOutput');
            container.innerHTML = '';
        }

        async function startRecon(event) {
            event.preventDefault();

            const formData = new FormData(event.target);
            const config = {};
            for (let [key, value] of formData.entries()) {
                if (value !== null && value !== undefined && value !== '') {
                    config[key] = value;
                }
            }

            // Handle checkboxes
            config.auto_install = document.getElementById('auto_install') ? document.getElementById('auto_install').checked : true;

            // convert numeric fields
            if (config.threads) config.threads = parseInt(config.threads, 10);
            if (config.max_hosts) config.max_hosts = parseInt(config.max_hosts, 10);

            try {
                const response = await fetch('/api/recon/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });

                const data = await response.json();
                if (data.status !== 'success') {
                    alert(data.message || 'Failed to start recon');
                    return;
                }

                currentReconId = data.recon_id;
                document.getElementById('reconStatus').classList.add('active');
                document.getElementById('viewBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                resetLogs();
                appendLogLine({ level: 'INFO', message: `Recon started: ${currentReconId}` });

                if (statusInterval) clearInterval(statusInterval);
                statusInterval = setInterval(loadStatus, 1500);

            } catch (e) {
                console.error(e);
                alert('Failed to start recon');
            }
        }

        async function loadStatus() {
            if (!currentReconId) return;

            try {
                const resp = await fetch(`/api/recon/status/${currentReconId}`);
                const data = await resp.json();
                if (data.status !== 'success') return;

                const st = data.data;
                const progress = Math.max(0, Math.min(100, Math.round(st.progress || 0)));
                document.getElementById('progressText').textContent = `${progress}%`;
                document.getElementById('progressBar').style.width = `${progress}%`;
                document.getElementById('statusText').textContent = st.status || '-';

                const summary = st.summary || {};
                document.getElementById('summarySubs').textContent = summary.subdomains || 0;
                document.getElementById('summaryLive').textContent = summary.live_endpoints || 0;

                if (st.start_time) {
                    document.getElementById('timeText').textContent = `Started: ${new Date(st.start_time).toLocaleString()}`;
                }

                // render new log lines (simple approach: re-render last 200 lines)
                resetLogs();
                (st.debug_messages || []).forEach(appendLogLine);

                if (st.status === 'completed' || st.status === 'error' || st.status === 'stopped') {
                    document.getElementById('stopBtn').disabled = true;
                    document.getElementById('viewBtn').disabled = false;
                    if (statusInterval) {
                        clearInterval(statusInterval);
                        statusInterval = null;
                    }
                }

            } catch (e) {
                console.error('Status error', e);
            }
        }

        async function stopRecon() {
            if (!currentReconId) return;
            if (!confirm('Stop this recon?')) return;

            try {
                await fetch(`/api/recon/stop/${currentReconId}`, { method: 'POST' });
            } catch (e) {
                console.error(e);
            }
        }

        function viewReconResults() {
            if (!currentReconId) return;
            window.location.href = `/recon/history?recon=${currentReconId}`;
        }

        document.getElementById('reconForm').addEventListener('submit', startRecon);

        function updateEngineUI() {
            // Only reconFTW engine exists; always show reconFTW fields and hide Python-only fields
            document.getElementById('reconftwFlagsWrap').style.display = 'block';
            document.getElementById('reconftwInstallWrap').style.display = 'block';
            document.getElementById('pythonModeWrap').style.display = 'none';
        }

        document.addEventListener('DOMContentLoaded', function() {
            updateEngineUI();
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        });
    </script>
</body>
</html>
